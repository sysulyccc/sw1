@startuml Index Enhancement Strategy System

skinparam classAttributeIconSize 0
skinparam packageStyle rectangle
skinparam linetype ortho

title Index Enhancement Strategy Backtest System - Class Diagram

' ==================== Layer 1: Domain Layer ====================
package "Layer 1: Domain (Instruments)" #LightBlue {
    
    class IndexDailyBar <<dataclass>> {
        +trade_date: date
        +open: float
        +high: float
        +low: float
        +close: float
    }
    
    class FuturesDailyBar <<dataclass>> {
        +trade_date: date
        +open: float
        +high: float
        +low: float
        +close: float
        +settle: float
        +pre_settle: float
        +volume: float
        +amount: float
        +open_interest: float
        +oi_change: float
    }
    
    class EquityIndex {
        +index_code: str
        +name: str
        -_daily_bars: Dict[date, IndexDailyBar]
        --
        +add_bar(bar: IndexDailyBar)
        +get_bar(trade_date: date): IndexDailyBar
        +get_close(trade_date: date): float
        +get_trading_dates(): List[date]
        +get_return_series(start, end): Series
        +get_nav_series(start, end): Series
    }
    
    class FuturesContract {
        +ts_code: str
        +fut_code: str
        +multiplier: float
        +list_date: date
        +delist_date: date
        +last_ddate: date
        +name: str
        -_daily_bars: Dict[date, FuturesDailyBar]
        --
        +is_listed(trade_date: date): bool
        +is_expired(trade_date: date): bool
        +is_tradable(trade_date: date): bool
        +get_bar(trade_date: date): FuturesDailyBar
        +get_price(trade_date, field): float
        +days_to_expiry(trade_date: date): int
        +get_volume(trade_date: date): float
        +get_open_interest(trade_date: date): float
    }
    
    class ContractChain {
        +index: EquityIndex
        +fut_code: str
        -_contracts: Dict[str, FuturesContract]
        --
        +add_contract(contract: FuturesContract)
        +get_contract(ts_code: str): FuturesContract
        +get_active_contracts(trade_date): List[FuturesContract]
        +get_nearby_contracts(trade_date, k): List[FuturesContract]
        +get_main_contract(trade_date, rule): FuturesContract
        +get_chain_snapshot(trade_date): Dict[str, FuturesDailyBar]
        +get_contracts_expiring_after(trade_date, min_days): List
    }
    
    EquityIndex "1" *-- "*" IndexDailyBar
    FuturesContract "1" *-- "*" FuturesDailyBar
    ContractChain "1" o-- "1" EquityIndex
    ContractChain "1" *-- "*" FuturesContract
}

' ==================== Layer 2: Data Layer ====================
package "Layer 2: Data (Handler & Snapshot)" #LightGreen {
    
    class MarketSnapshot {
        +trade_date: date
        +index_bar: IndexDailyBar
        +futures_quotes: Dict[str, FuturesDailyBar]
        --
        +get_contract_bar(ts_code: str): FuturesDailyBar
        +get_futures_price(ts_code, field): float
        +get_index_close(): float
        +get_basis(ts_code, relative): float
        +get_available_contracts(): List[str]
    }
    
    class DataHandler {
        +index: EquityIndex
        +contract_chain: ContractChain
        +calendar: List[date]
        -_margin_rates: Dict
        -_snapshot_cache: Dict[date, MarketSnapshot]
        --
        +{static} from_processed_data(data_path, fut_code): DataHandler
        +get_trading_calendar(start, end): List[date]
        +get_snapshot(trade_date: date): MarketSnapshot
        +get_contract_chain(): ContractChain
        +get_index(): EquityIndex
        +get_margin_rate(trade_date, default): float
        +get_prev_trading_date(trade_date): date
        +get_next_trading_date(trade_date): date
    }
    
    DataHandler "1" o-- "1" EquityIndex
    DataHandler "1" o-- "1" ContractChain
    DataHandler ..> MarketSnapshot : creates
    MarketSnapshot o-- IndexDailyBar
    MarketSnapshot o-- FuturesDailyBar
}

' ==================== Layer 3: Account Layer ====================
package "Layer 3: Account (Portfolio)" #LightYellow {
    
    class TradeRecord <<dataclass>> {
        +trade_date: date
        +ts_code: str
        +direction: str
        +volume: int
        +price: float
        +amount: float
        +commission: float
        +reason: str
    }
    
    class Position {
        +contract: FuturesContract
        +volume: int
        +entry_price: float
        +last_settle: float
        --
        +ts_code: str {property}
        +multiplier: float {property}
        +mark_to_market(trade_date: date): float
        +notional_value(trade_date: date): float
        +days_to_expiry(trade_date: date): int
        +is_expired(trade_date: date): bool
        +update_volume(delta, price): float
    }
    
    class Account {
        +initial_capital: float
        +margin_rate: float
        +commission_rate: float
        +cash: float
        +realized_pnl: float
        +unrealized_pnl: float
        -_positions: Dict[str, Position]
        -_nav_history: Dict[date, float]
        -_trade_log: List[TradeRecord]
        --
        +equity: float {property}
        +nav: float {property}
        +mark_to_market(snapshot: MarketSnapshot): float
        +required_margin(snapshot: MarketSnapshot): float
        +available_margin(snapshot: MarketSnapshot): float
        +get_position(ts_code: str): Position
        +get_position_volume(ts_code: str): int
        +rebalance_to_target(target_positions, snapshot, contracts): float
        +record_nav(trade_date: date)
        +get_nav_series(): Series
        +get_trade_summary(): DataFrame
        +get_holding_contracts(): List[str]
    }
    
    Position o-- FuturesContract
    Account "1" *-- "*" Position
    Account "1" *-- "*" TradeRecord
}

' ==================== Layer 4: Strategy Layer ====================
package "Layer 4: Strategy" #LightPink {
    
    abstract class Strategy {
        +contract_chain: ContractChain
        --
        +{abstract} on_bar(snapshot, account): Dict[str, int]
        +fut_code: str {property}
        +index: EquityIndex {property}
    }
    
    class BaselineRollStrategy {
        +roll_days_before_expiry: int
        +contract_selection: str
        +target_leverage: float
        +min_roll_days: int
        -_current_contract: FuturesContract
        --
        +on_bar(snapshot, account): Dict[str, int]
        -_should_roll(contract, trade_date): bool
        -_select_contract(trade_date): FuturesContract
        -_select_roll_target(trade_date, current): FuturesContract
        -_calculate_target_volume(contract, snapshot, account): int
        +current_contract: FuturesContract {property}
    }
    
    class BasisTimingStrategy {
        +basis_entry_threshold: float
        +basis_exit_threshold: float
        +lookback_window: int
        +use_percentile: bool
        +entry_percentile: float
        +exit_percentile: float
        +position_scale_by_basis: bool
        -_basis_history: deque
        -_position_state: str
        --
        +on_bar(snapshot, account): Dict[str, int]
        -_get_timing_signal(basis: float): str
        -_calculate_percentile(basis: float): float
        -_adjust_volume_by_basis(base_volume, basis): int
        +select_best_discount_contract(snapshot, min_vol): str
    }
    
    Strategy <|-- BaselineRollStrategy
    BaselineRollStrategy <|-- BasisTimingStrategy
    Strategy o-- ContractChain
}

' ==================== Layer 5: Backtest Layer ====================
package "Layer 5: Backtest (Engine & Analyzer)" #LightGray {
    
    class BacktestResult <<dataclass>> {
        +nav_series: Series
        +benchmark_nav: Series
        +trade_summary: DataFrame
        +metrics: Dict[str, float]
        +analyzer: Analyzer
    }
    
    class BacktestEngine {
        +data_handler: DataHandler
        +strategy: Strategy
        +initial_capital: float
        +margin_rate: float
        +commission_rate: float
        +account: Account
        +analyzer: Analyzer
        --
        +run(start_date, end_date, verbose): BacktestResult
        -_process_day(trade_date, contracts)
        -_print_summary(metrics)
    }
    
    class Analyzer {
        +nav_series: Series
        +benchmark_nav: Series
        +trade_log: List[TradeRecord]
        +risk_free_rate: float
        --
        +compute_metrics(): Dict[str, float]
        +plot_nav_comparison(figsize, title): Figure
        +plot_drawdown(figsize, title): Figure
        +plot_excess_returns(figsize, title): Figure
        +plot_monthly_returns(figsize, title): Figure
        +generate_report(): str
        +save_plots(output_dir, prefix)
    }
    
    BacktestEngine o-- DataHandler
    BacktestEngine o-- Strategy
    BacktestEngine o-- Account
    BacktestEngine o-- Analyzer
    BacktestEngine ..> BacktestResult : creates
    BacktestResult o-- Analyzer
}

' ==================== Cross-Layer Dependencies ====================
MarketSnapshot ..> Account : used by
Strategy ..> MarketSnapshot : reads
Strategy ..> Account : reads
Account ..> MarketSnapshot : reads

@enduml
